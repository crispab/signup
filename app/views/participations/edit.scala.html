@(participationForm: Form[Participation], user: User, event: Event)(implicit loggedInUser: Option[User])

@import util.AuthHelper._
@import util.DateHelper._
@import util.FormHelper._
@import util.Section._
@import services.ImageUrl

@field(fieldName: String) = @{ participationForm(fieldName).value.getOrElse("") }

@hasErrors(fieldName: String) = @{ if(participationForm(fieldName).hasErrors) { "error" } }


@page("Anmälan till " + event.name, section = Groups) {

@breadcrumb(Seq("Grupper" -> routes.Groups.list(), event.group.name -> routes.Groups.show(event.group.id.get), event.name -> routes.Events.show(event.id.get)),
            "Anmälan")

<div class="row">
  <div class="span5">
    <h2>Anmälan till @event.name</h2>

    @event match {
      case ev if(ev.endTime.before(new java.util.Date())) => {
        <div class="alert alert-danger">
          <button type="button" class="close" data-dismiss="alert">×</button>
          Det här eventet har redan inträffat!
        </div>
      }
      case ev if(ev.lastSignupDatePassed) => {
        <div class="alert alert-info">
          <button type="button" class="close" data-dismiss="alert">×</button>
          <img class="warning-icon" src='@routes.Assets.at("images/icon-warning.png")'/>
          Sista anmälningsdatum har passerats.
        </div>
      }
      case _ => {}
    }
  </div>
</div>

<div class="row">
  <div class="span5">
    <div class="well">
      <p>@Html(event.description)</p>
      <ul>
        <li><strong>Tid:</strong> @asDateTime(event.startTime)-@asTime(event.endTime)</li>
        <li><strong>Plats:</strong> @event.venue</li>
      </ul>
      @if(!sameDay(event.startTime, event.lastSignUpDate)) {
        <p>Sista anmälningsdag @asDate(event.lastSignUpDate)</p>
      }

      @views.html.events.tags.addToCalendarButton(event)

      @if(isAdmin(loggedInUser)) {
        <a data-toggle="modal" href="#notify_participant" class="btn"><i class="icon-envelope"></i> Påminn deltagaren</a>

        <div id="notify_participant" class="modal smaller-modal hide fade" style="display: none">
          <div class="modal-header">
            <button class="close transparent" data-dismiss="modal"><i class="icon-remove"></i></button>
            <h3>Vill du e-posta deltagaren?</h3>
          </div>
          <div class="modal-body">
            <p>
              Du håller på att skicka en påminnelse via e-post till <strong>@user.firstName @user.lastName</strong> om eventet <strong>@event.name</strong>.
            </p>
            <p>
              Vill du fortsätta?
            </p>
          </div>
          <div class="modal-footer">
            <form action="@routes.UsersSecured.notifyParticipant(user.id.get, event.id.get)" method="POST">
              <a href="#" class="btn" data-dismiss="modal"><i class="icon-ban-circle"></i> Avbryt</a>
              <button type="submit" class="btn btn-primary"><i class="icon-envelope icon-white"></i> Påminn deltagaren</button>
            </form>
          </div>
        </div>
      }

    </div>
  </div>
</div>


<div class="row">
  <div class="span5">
    <form action="@routes.Participations.createOrUpdate()" method="POST">
      <fieldset>
        <div class='control-group  @hasErrors("status")'>
          <label class="control-label big-name">
            <img class="thumb thumb-background80" src="@ImageUrl(user, size = 80)" onerror="imgError(this);"/>
            @user.firstName @user.lastName
          </label>
          <div class="controls">
            <label class="radio inline">
              <input type="radio" name="status" id="on" value="On" @if(field("status") == Status.On.toString  || field("status") == Status.Unregistered.toString) {checked=""}/>
              <span class="label participation-on">Kommer</span>
            </label>
            <label class="radio inline">
              <input type="radio" name="status" id="maybe" value="Maybe" @if(field("status") == Status.Maybe.toString) {checked=""}/>
              <span class="label participation-maybe">Kanske</span>
            </label>
            <label class="radio inline">
              <input type="radio" name="status" id="off" value="Off" @if(field("status") == Status.Off.toString) {checked=""}/>
              <span class="label participation-off">Kommer inte</span>
            </label>
          </div>
        </div>

        @if(event.allowExtraFriends) {
          <div class='form-inline control-group @hasErrors("number_of_participants")'>
            <label class="control-label" for="number_of_participants">Antal deltagare</label>
            <input type="number" class="input-mini" id="number_of_participants" name="number_of_participants" value='@field("number_of_participants")' min="1" />
          </div>
        } else {
          <input type="hidden" id="number_of_participants" name="number_of_participants" value="1"/>
        }

        <div class='control-group  @hasErrors("comment")'>
          <label class="control-label" for="comment">Kommentar</label>
          <div class="controls">
            <textarea maxlength="127" class="span5" id="comment" name="comment" rows="2">@field("comment")</textarea>
          </div>
        </div>

        <input type="hidden" id="userId" name="userId" value='@field("userId")'/>
        <input type="hidden" id="eventId" name="eventId" value='@field("eventId")'/>

        @if(participationForm.hasErrors || participationForm.hasGlobalErrors) {
        <div class="alert alert-error">
          <a class="close" data-dismiss="alert" href="#">×</a>
          <h4 class="alert-heading">Inmatningsfel</h4>
          <p>@errors(participationForm).mkString(", ")</p>
        </div>
        }


        <div class="form-actions">
          <button type="submit" class="btn btn-primary" id="action" name="action" value="save">
            <i class="icon-ok icon-white"></i>
            Spara
          </button>
          <button type="button" class="btn" id="cancel"
                  onClick='window.location.assign("@routes.Events.show(event.id.get)") '>
            <i class="icon-ban-circle"></i>
            Avbryt
          </button>
        </div>
      </fieldset>
    </form>
  </div>
</div>
}